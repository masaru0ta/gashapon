# 仕様書: 1-1 マップ表示

## 1. 概要

プレイヤーがゲームの戦略フェーズにおいて、マップ全体の状況を視覚的に把握するための機能。18種の地形タイルで構成されたマップを描画し、スクロール・ズーム・タイル選択などの操作でマップ上の情報を確認できるようにする。

**この仕様の範囲**: マップの描画、スクロール、ズーム、タイル選択、地形情報表示、ミニマップ、ステータスバーの表示

**範囲外**: ユニットの描画・移動（2-1）、占領処理（1-2）、戦闘遷移（3-1）、ユニット生産UI（5-1）、ターン進行ロジック（7-1）

**対応デバイス**: PC（マウス・キーボード）、モバイル（タッチ操作）

**使用技術**: HTML5 Canvas、JavaScript（バニラ）、Google Fonts（DotGothic16）

## 2. 画面レイアウト等の補足資料等の関連資料

### 2.1 モックアップ

- [マップ表示モックアップHTML](mockups/spec_1-1_map_display.html)
- [参考画像（原作スクリーンショット）](mockups/spec_1-1_map_display_sample.jpg)

### 2.2 参照ドキュメント

- [機能一覧](spec_list.md)

### 2.3 アセット

- **地形タイル画像**: `assets/terrain/` 配下の18種GIFファイル（各16x16px）
- **マップデータ**: `assets/maps/map01.png` 〜 `map30.png`（将来的にデータ化予定）
- **フォント**: DotGothic16（Google Fonts CDN）

## 3. 機能詳細

### 3.1 画面要素

画面は大きく **マップエリア**（上部）と **ステータスバー**（下部固定）の2領域で構成される。全体の最大幅は1200pxとし、画面中央に配置する。

#### 3.1.1 マップエリア

| 要素 | 説明 |
|------|------|
| メインキャンバス | マップを描画するHTML5 Canvas。`image-rendering: pixelated` でドット絵のシャープさを保持 |
| 地形タイル | 16x16pxの地形画像をスケール倍率に応じて拡大描画。画像読み込み失敗時はフォールバックカラーで塗りつぶし |
| グリッド線 | 各タイルの境界線。色: `rgba(200, 200, 200, 0.2)`、線幅: 1px |
| ホバーハイライト | マウスカーソル直下のタイルを白半透明で強調。塗り: `rgba(255, 255, 255, 0.15)`、枠: `rgba(255, 255, 255, 0.5)` 線幅2px |
| 選択ハイライト | 選択中タイルを黄色枠 `#ffcc00` で強調、500ms間隔で点滅。四隅にコーナーマーカー付き |
| 地形情報オーバーレイ | マップエリア左下に半透明黒背景で座標と地形名を表示。書式: `(col, row) | 地形名` |

#### 3.1.2 ステータスバー

高さ固定180px、背景色 `#1a1a2e`。3カラム構成。

| 位置 | 要素 | 詳細 |
|------|------|------|
| 左カラム | P1プレイヤー情報 | IG（収入）、CT（資金）、GP数、T（生産中）数、GB数、ユニット総数 |
| 中央カラム | ターン・ミニマップ | ターン番号（緑、背景 `#224422`）、フェーズ表示（オレンジ `#cc8844`）、ミニマップキャンバス(200x120px) |
| 右カラム | P2プレイヤー情報 | 左カラムと同じ項目を右寄せで表示 |

**色定義**:

| 要素 | 色 |
|------|-----|
| IG/CT値 | `#44cc44`（緑） |
| GPアイコン | `#4488ff`（青） |
| GBアイコン | `#ff4488`（ピンク） |
| T（生産中）アイコン | `#44cc44`（緑） |
| P1ユニット数 | `#4488ff`（青） |
| P2ユニット数 | `#ff4488`（ピンク） |
| ターン番号 | `#44cc44`（緑） |
| フェーズ | `#cc8844`（オレンジ） |

**フォント**: DotGothic16。ユニット数は42px太字、ターン番号は28px太字、IG/CTは18px、その他は16px。

#### 3.1.3 ミニマップ

| 項目 | 値 |
|------|-----|
| サイズ | 200x120px |
| 枠線 | 1px solid `#888` |
| 背景 | `#222` |
| 描画方式 | 各タイルをフォールバックカラーで塗りつぶし（画像は使用しない） |
| ビューポート表示 | メインマップの表示範囲をオレンジ枠（`#ff8800`、線幅2px）で表示 |

### 3.2 処理ロジック

#### 3.2.1 マップ描画処理

1. Canvas全体をクリア
2. 現在のスクロール位置とスケールから、画面内に表示されるタイル範囲を計算（視野外タイルは描画スキップ）
3. 範囲内の各タイルについて:
   - 画像が読み込み済みの場合: `drawImage` でスケール倍率に応じて描画
   - 画像未読み込み/読み込み失敗の場合: フォールバックカラーで `fillRect`
4. グリッド線を描画
5. ホバーハイライトを描画（カーソル位置のタイルのみ）
6. 選択ハイライトを描画（選択中かつ点滅状態が表示の場合のみ）

#### 3.2.2 スクロール処理

| 操作 | 動作 |
|------|------|
| マウスドラッグ | ドラッグ量に応じてピクセル単位でスクロール。Canvas座標系に変換して計算 |
| タッチドラッグ | 1本指タッチでマウスドラッグと同様の動作 |
| キーボード矢印キー | 1回押下につき32pxスクロール。`e.preventDefault()` でページスクロールを抑制 |
| ミニマップクリック/ドラッグ | クリック位置を中心にメインマップのビューを移動。クリックしたままマウスを動かすとメインマップが追従してスクロールする |

**スクロール制約（エッジケース）**:
- スクロール位置は `0` 〜 `(マップ全体サイズ - Canvas表示サイズ)` にクランプ
- マップ全体がCanvas内に収まる場合、スクロールは無効（最大値が0になる）
- ウィンドウリサイズ時にもクランプを再適用

#### 3.2.3 ズーム処理

| 操作 | 動作 |
|------|------|
| マウスホイール | ホイール上で拡大（×1.1）、下で縮小（×0.9）。カーソル位置を中心にズーム |
| ピンチ（タッチ） | 2本指の距離変化に比例してスケール変更。ピンチ中心を基準にズーム |

**ズーム制約**:
- スケール範囲: `1`（等倍）〜 `4`（4倍）
- ズーム時、カーソル/ピンチ中心のマップ座標を維持するようスクロール位置を再計算
- ズーム後にスクロールクランプを適用

#### 3.2.4 タイル選択処理

| 操作 | 動作 |
|------|------|
| クリック（マウス） | ドラッグ距離が2px以下の場合のみ選択として扱う |
| タップ（タッチ） | ドラッグ距離が3px以下の場合のみ選択として扱う |

**選択ロジック**:
- 同じタイルを再度選択すると選択解除（トグル動作）
- マップ範囲外のタイル座標は選択不可
- 選択時は点滅状態を表示状態にリセット

**点滅処理**:
- 500msごとに表示/非表示を切り替え（`setInterval`）
- 選択タイルがない場合は点滅タイマーの描画更新をスキップ

#### 3.2.5 座標変換処理

Canvas上のクライアント座標（clientX/clientY）をマップ座標（col/row）に変換する。

```
canvasX = (clientX - canvasRect.left) × (canvasWidth / canvasRect.width)
canvasY = (clientY - canvasRect.top) × (canvasHeight / canvasRect.height)
col = floor((canvasX + scrollX) / tileScaledSize)
row = floor((canvasY + scrollY) / tileScaledSize)
```

- `tileScaledSize = TILE_SIZE × scale`（16 × スケール倍率）
- CSSによるCanvas引き伸ばしに対応するため、クライアント座標をCanvas内部座標に変換してから計算

#### 3.2.6 ホバー処理

- マウス移動時（ドラッグ中でない場合）にカーソル位置のマップ座標を計算
- 座標がマップ範囲内の場合: ホバー状態を更新し、地形情報オーバーレイを表示
- マウスがCanvasから離脱した場合: ホバー状態をリセット、オーバーレイを非表示

#### 3.2.7 ミニマップ処理

**描画**:
1. マップ全体を200x120pxに縮小し、各タイルをフォールバックカラーで塗りつぶし
2. メインマップの現在のビューポート範囲をオレンジ枠で表示
3. ビューポート枠がミニマップ領域を超えないようクリップ

**操作**:
- クリック: クリック位置に対応するマップ座標を中心にメインマップのビューを移動
- ドラッグ: mousedown でドラッグ状態に入り、mousemove でマウス位置に追従してメインマップをスクロールし続ける。mouseup でドラッグ状態を解除
- ミニマップ上の座標からメインマップのスクロール位置への変換式:
  - `scrollX = (mouseX / miniMapWidth) × MAP_COLS × tileScaledSize - canvasW / 2`
  - `scrollY = (mouseY / miniMapHeight) × MAP_ROWS × tileScaledSize - canvasH / 2`
- 変換後にスクロールクランプを適用

#### 3.2.8 画像読み込み処理

- 全18種の地形タイル画像を `assets/terrain/` から非同期読み込み
- `onload`/`onerror` の両方をカウントし、全画像の読み込み完了後にCanvas初期描画を実行
- 読み込み失敗した画像は `null` をセットし、描画時にフォールバックカラーを使用

#### 3.2.9 リサイズ処理

- `window.resize` イベントでCanvasサイズをマップエリアのクライアントサイズに再設定
- リサイズ後にスクロールクランプ→メインマップ描画→ミニマップ描画を実行
- 初期化時に50ms遅延で `resizeCanvas` を呼び出し、レイアウト確定後のサイズを取得

### 3.3 データ設計

#### 3.3.1 地形データ

**データ取得元**: JavaScript内の定数配列（将来的にはGASからの読み込みに変更予定）

```javascript
// 地形定義 (18種)
const TERRAINS = [
  { id: number, name: string, file: string, color: string }
  // ...
];
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| id | number | 地形ID（1〜18） |
| name | string | 日本語地形名 |
| file | string | タイル画像ファイル名（GIF） |
| color | string | フォールバックカラー（HEX） |

**地形一覧**:

| ID | 地形名 | ファイル | フォールバックカラー |
|----|--------|----------|---------------------|
| 1 | 宇宙 | space.gif | `#000000` |
| 2 | 平野 | plainicon.gif | `#00aa00` |
| 3 | 森林 | foresticon.gif | `#006600` |
| 4 | アステロイド | aste.gif | `#666666` |
| 5 | 水中 | seaicon.gif | `#0044cc` |
| 6 | 砂漠 | deserticon.gif | `#ccaa00` |
| 7 | 大気圏 | air.gif | `#884400` |
| 8 | 火山 | volicon.gif | `#cc4400` |
| 9 | 小惑星 | moon.gif | `#999999` |
| 10 | クレータ | cresmall.gif | `#aaaaaa` |
| 11 | ブラックホール | bhole.gif | `#220022` |
| 12 | 大クレータ | crelarge.gif | `#bbbbbb` |
| 13 | GP | redgpicon.gif | `#cc0000` |
| 14 | GB | redgb.gif | `#0000cc` |
| 15 | 都市 | cityicon.gif | `#888888` |
| 16 | コロニー | colony.gif | `#44aa88` |
| 17 | 補給基地 | baseicon.gif | `#aa8844` |
| 18 | スペースベース | sbase.gif | `#4488aa` |

#### 3.3.2 マップデータ

**データ取得元**: JavaScript内の2次元配列（将来的にはGASからの読み込みに変更予定）

```javascript
// マップデータ (rows × cols の2次元配列)
const MAP_DATA = number[][];
```

| フィールド | 型 | 制約 |
|------------|-----|------|
| MAP_DATA[row][col] | number | 地形ID（1〜18）。TERRAINS配列のidと一致すること |
| MAP_ROWS | number | マップの行数（現在25） |
| MAP_COLS | number | マップの列数（現在25） |

#### 3.3.3 表示状態

| 変数 | 型 | 初期値 | 説明 |
|------|-----|--------|------|
| scale | number | 2 | 現在のズーム倍率（1〜4） |
| scrollX | number | 0 | 水平スクロール位置（px） |
| scrollY | number | 0 | 垂直スクロール位置（px） |
| hoverCol | number | -1 | ホバー中のタイル列（-1で無効） |
| hoverRow | number | -1 | ホバー中のタイル行（-1で無効） |
| selectedCol | number | -1 | 選択中のタイル列（-1で未選択） |
| selectedRow | number | -1 | 選択中のタイル行（-1で未選択） |
| blinkVisible | boolean | true | 選択カーソルの点滅表示状態 |

#### 3.3.4 定数

| 定数 | 値 | 説明 |
|------|-----|------|
| TILE_SIZE | 16 | タイル基本サイズ（px） |
| MIN_SCALE | 1 | 最小ズーム倍率 |
| MAX_SCALE | 4 | 最大ズーム倍率 |
| SCROLL_SPEED | 32 | キーボードスクロール速度（px/回） |

### 3.4 テスト用インターフェース

#### 3.4.1 実装ファイルパス

- `src/index.html` — マップ表示のメインページ

#### 3.4.2 data-testid 属性

テストコードからDOM要素を特定するため、以下の `data-testid` 属性を実装時に付与すること。

| data-testid | 対象要素 |
|---|---|
| `game-container` | ゲーム全体のコンテナ |
| `map-area` | マップエリア |
| `map-canvas` | メインマップCanvas |
| `terrain-overlay` | 地形情報オーバーレイ |
| `coord-text` | 座標テキスト |
| `terrain-name` | 地形名テキスト |
| `status-bar` | ステータスバー |
| `p1-info` | P1プレイヤー情報エリア |
| `p2-info` | P2プレイヤー情報エリア |
| `p1-ig` | P1 IG値 |
| `p1-ct` | P1 CT値 |
| `p1-gp` | P1 GP数 |
| `p1-gb` | P1 GB数 |
| `p1-production` | P1 生産中数 |
| `p1-unit-count` | P1 ユニット総数 |
| `p2-ig` | P2 IG値 |
| `p2-ct` | P2 CT値 |
| `p2-gp` | P2 GP数 |
| `p2-gb` | P2 GB数 |
| `p2-production` | P2 生産中数 |
| `p2-unit-count` | P2 ユニット総数 |
| `turn-number` | ターン番号 |
| `turn-phase` | フェーズ表示 |
| `mini-map-canvas` | ミニマップCanvas |

#### 3.4.3 グローバル状態オブジェクト（window.gameState）

テストコードから内部状態を読み取るため、`window.gameState` を公開すること。

```javascript
window.gameState = {
  scale: number,       // 現在のズーム倍率
  scrollX: number,     // 水平スクロール位置（px）
  scrollY: number,     // 垂直スクロール位置（px）
  selectedCol: number, // 選択中タイル列（-1で未選択）
  selectedRow: number, // 選択中タイル行（-1で未選択）
  hoverCol: number,    // ホバー中タイル列（-1で無効）
  hoverRow: number,    // ホバー中タイル行（-1で無効）
  MAP_COLS: number,    // マップ列数
  MAP_ROWS: number,    // マップ行数
  TILE_SIZE: number,   // タイル基本サイズ
  MIN_SCALE: number,   // 最小ズーム倍率
  MAX_SCALE: number,   // 最大ズーム倍率
  SCROLL_SPEED: number // キーボードスクロール速度
};
```

- `gameState` は描画更新のたびに最新の値を反映すること
- 読み取り専用として公開し、テストコードからの書き込みは想定しない

## 4. 非機能要件

- **描画性能**: 60fpsを目標とする。視野外タイルの描画スキップにより、大きなマップでも安定した描画速度を維持すること
- **`image-rendering: pixelated`** を適用し、ドット絵の拡大時にぼやけない描画を実現すること
- **レスポンシブ**: ウィンドウリサイズに追従してCanvasサイズを動的に変更すること
- **タッチ操作**: `touch-action: none` でブラウザデフォルトのタッチジェスチャーを無効化し、ゲーム操作と競合しないこと
- **初期表示**: 全タイル画像の読み込み完了後に初期描画を行い、画像ロード中の表示崩れを防ぐこと

## 5. 考慮事項・制限事項

- **ユニット描画は範囲外**: ユニットのマップ上での描画・選択・移動は仕様 2-1（ユニット移動）で対応する。本仕様はマップ地形の描画のみを扱う
- **占領状態の表示は範囲外**: GP/GBのプレイヤー別カラー切り替えは仕様 1-2（占領システム）で対応する。本仕様ではGP/GBは固定の1色で表示する
- **ステータスバーの値は静的**: 本仕様ではステータスバーの値（IG、CT、GP数など）はハードコードされたダミー値を表示する。動的な更新はターン管理（7-1）やユニット生産（5-1）と連携して行う
- **マップデータはハードコード**: 現時点ではJavaScript内にサンプルマップを定義する。GASからの動的読み込みは将来対応
- **GP/GBの軍別アイコン**: `assets/terrain/` にはGP/GBそれぞれ赤版・青版の画像があるが、本仕様では各1色のみ使用する。占領状態に応じたアイコン切り替えは 1-2 で対応
- **サウンド**: 本仕様では効果音・BGMは扱わない

## 6. テスト方針

### テスト観点

- **正常系**: 各操作（スクロール、ズーム、タイル選択、ミニマップ）が仕様通りに動作すること
- **境界値**: スクロール範囲の端、ズームの最大/最小、マップ端のタイル選択
- **異常系**: 画像読み込み失敗時のフォールバック表示、マップ範囲外クリック
- **性能**: 描画が滑らかに動作すること（目視確認）
- **クロスデバイス**: PC（マウス・キーボード）とモバイル（タッチ操作）の両方で動作確認

### テスト手法

- **Playwright UIテスト**: ページ表示、要素の存在確認、マウス操作シミュレーション、スクリーンショット比較
- **目視確認**: アニメーション（点滅）、描画品質、レスポンシブ表示はPlaywrightテスト後に人間が目視で最終確認

### テストデータ

- モックアップに含まれる25x25のサンプルマップデータを使用
- 18種すべての地形タイルがサンプルマップ内に含まれていること

## 7. テスト項目

### 初期表示

- ページを開くとマップエリアとステータスバーが表示される
- 18種すべての地形タイルが正しい色または画像で描画される
- グリッド線がタイルの境界に沿って表示される
- ステータスバーにP1情報（IG, CT, GP, T, GB, ユニット数）が表示される
- ステータスバーにP2情報（IG, CT, GP, T, GB, ユニット数）が表示される
- ステータスバー中央にターン番号とフェーズが表示される
- ミニマップが表示され、マップ全体の縮小図が描画される
- ミニマップ上にビューポート範囲を示すオレンジ枠が表示される

### スクロール（マウスドラッグ）

- マップ上でマウスをドラッグするとマップがスクロールする
- ドラッグ方向と逆方向にマップが移動する（自然なスクロール）
- ドラッグ中はカーソルが `grabbing` になる
- スクロール中にミニマップのビューポート枠が連動して移動する

### スクロール（キーボード）

- 矢印キー左でマップが左にスクロールする
- 矢印キー右でマップが右にスクロールする
- 矢印キー上でマップが上にスクロールする
- 矢印キー下でマップが下にスクロールする
- 1回の押下で32pxスクロールする

### スクロール境界

- マップ左端を超えてスクロールできない（scrollX が 0 未満にならない）
- マップ上端を超えてスクロールできない（scrollY が 0 未満にならない）
- マップ右端を超えてスクロールできない
- マップ下端を超えてスクロールできない

### ズーム（マウスホイール）

- ホイール上回転でマップが拡大される
- ホイール下回転でマップが縮小される
- ズーム時、カーソル位置のマップ座標が維持される（カーソル下の地形が変わらない）
- ズーム後にミニマップのビューポート枠が更新される

### ズーム境界

- ズーム倍率が1倍未満にならない
- ズーム倍率が4倍を超えない
- 最小ズーム（1倍）でさらに縮小操作しても表示が崩れない
- 最大ズーム（4倍）でさらに拡大操作しても表示が崩れない

### タッチ操作

- 1本指ドラッグでマップがスクロールする
- 2本指ピンチインでマップが縮小される
- 2本指ピンチアウトでマップが拡大される
- ピンチ操作のズーム中心が2本指の中間点になる
- ピンチからドラッグへの切り替え（指を1本離す）が正常に動作する

### タイル選択

- マップ上のタイルをクリックすると黄色の選択枠が表示される
- 選択枠が500ms間隔で点滅する
- 選択中のタイルを再度クリックすると選択が解除される
- 別のタイルをクリックすると選択が移動する
- ドラッグ操作ではタイルが選択されない（ドラッグ距離が閾値を超えた場合）
- タッチでタップするとタイルが選択される
- タッチドラッグではタイルが選択されない

### ホバー表示

- マウスをタイルの上に移動するとホバーハイライトが表示される
- ホバー中に地形情報オーバーレイ（座標・地形名）が表示される
- 地形情報オーバーレイの座標が正しい（0始まり、列,行の順）
- 地形情報オーバーレイの地形名が正しい
- マウスがCanvasから離れるとホバーハイライトとオーバーレイが消える

### ミニマップ

- ミニマップがマップ全体を表す縮小図として表示される
- ミニマップ上のビューポート枠がメインマップの表示範囲と一致する
- ミニマップをクリックするとクリック位置を中心にメインマップがスクロールする
- ミニマップ上でクリックしたままマウスを動かすとメインマップが追従してスクロールする
- ミニマップのドラッグ中にマウスボタンを離すとドラッグが終了する
- スクロール・ズーム操作でビューポート枠がリアルタイムに更新される

### 画像フォールバック

- 地形タイル画像が読み込めない場合、フォールバックカラーで表示される
- フォールバック表示でもグリッド線・ホバー・選択が正常に動作する

### レスポンシブ

- ブラウザのウィンドウサイズを変更するとCanvasサイズが追従する
- リサイズ後もスクロール・ズーム・タイル選択が正常に動作する
- 最大幅1200px以内に収まる

### ステータスバー

- P1のIG値が表示される
- P1のCT値が表示される
- P1のGP数・GB数・T数が表示される
- P1のユニット総数が青色の大きなフォントで表示される
- P2のIG値が表示される
- P2のCT値が表示される
- P2のGP数・GB数・T数が表示される
- P2のユニット総数がピンク色の大きなフォントで表示される
- ターン番号が緑色で表示される
- フェーズ表示がオレンジ色で表示される
