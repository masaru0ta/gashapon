# 仕様書: 1-1 マップ表示

## 1. 概要

18種の地形タイルで構成される2次元グリッドマップを HTML5 Canvas 上に描画する機能。マップは縦横のタイル数で定義され、各セルが地形タイプID（1〜18）を持つ。Canvas のビューポートに表示しきれないマップはスクロールにより表示範囲を移動する。拠点（GP・GB・都市・コロニー・補給基地・スペースベース）は所有プレイヤーに応じた色で描画する。

**この仕様の範囲**: マップデータの保持、地形タイルの描画、拠点の所有色表示、スクロール制御。
**範囲外**: ユニット表示（4-1）、移動処理（2-1）、占領処理（1-2）。

**使用技術**: HTML5 Canvas API、JavaScript（GAS の Web アプリとして動作）

## 2. 画面レイアウト等の補足資料等の関連資料

### 2.1 モックアップ

```
+----------------------------------------------------------+
|  マップ Canvas (640 x 480 px)                            |
|  +------------------------------------------------------+|
|  | [宇宙][宇宙][aste][宇宙][宇宙][colony]... (20列)    ||
|  | [宇宙][GP赤][宇宙][宇宙][都市灰][宇宙]...          ||
|  | [平野][森林][砂漠][水中][平野 ][補給青]...          ||
|  | [平野][火山][平野][GB青][平野 ][平野 ]...          ||
|  |  ...                                                ||
|  | (15行 × 各32x32px)                                  ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+

各セル = 32×32px の地形タイル画像
拠点タイルは所有者に応じた色バリエーションで描画
ビューポート外のマップはスクロールで表示
```

### 2.2 参照ドキュメント

- [capsule_senki_spec.md](capsule_senki_spec.md) セクション2「マップシステム」
- [spec_list.md](spec_list.md) 機能番号1-1

### 2.3 アセット

地形タイル画像は `assets/terrain/` ディレクトリに格納する。ファイル形式は GIF、サイズは 32×32px。

## 3. 機能詳細

### 3.1 画面要素

#### 3.1.1 Canvas

| 項目 | 値 |
|------|-----|
| 幅 | 640px |
| 高さ | 480px |
| 背景色 | `#000000`（黒） |
| タイルサイズ | 32 × 32px |
| ビューポートサイズ | 横20タイル × 縦15タイル |

#### 3.1.2 地形タイル一覧

18種の地形タイルを ID で管理する。各タイルは 32×32px の画像として描画する。

| ID | 地形名 | 画像ファイル | 進入可否 | カテゴリ |
|----|--------|-------------|---------|---------|
| 1 | 宇宙 | `space.gif` | 可 | 自然地形 |
| 2 | 平野 | `plainicon.gif` | 可 | 自然地形 |
| 3 | 森林 | `foresticon.gif` | 可 | 自然地形 |
| 4 | アステロイド | `aste.gif` | 可 | 自然地形 |
| 5 | 水中 | `seaicon.gif` | 可 | 自然地形 |
| 6 | 砂漠 | `deserticon.gif` | 可 | 自然地形 |
| 7 | 大気圏 | `air.gif` | 可 | 自然地形 |
| 8 | 火山 | `volicon.gif` | 不可 | 自然地形 |
| 9 | 小惑星 | `moon.gif` | 可 | 自然地形 |
| 10 | クレータ | `cresmall.gif` | 可 | 自然地形 |
| 11 | ブラックホール | `bhole.gif` | 不可 | 自然地形 |
| 12 | 大クレータ | `crelarge.gif` | 可 | 自然地形 |
| 13 | GP | 所有者別（3.1.3参照） | 可 | 拠点 |
| 14 | GB | 所有者別（3.1.3参照） | 可 | 拠点 |
| 15 | 都市 | 所有者別（3.1.3参照） | 可 | 拠点 |
| 16 | コロニー | 所有者別（3.1.3参照） | 可 | 拠点 |
| 17 | 補給基地 | 所有者別（3.1.3参照） | 可 | 拠点 |
| 18 | スペースベース | 所有者別（3.1.3参照） | 可 | 拠点 |

#### 3.1.3 拠点の所有者別表示

拠点（ID 13〜18）は所有プレイヤーに応じて異なる画像を描画する。

**GP・GB（生産拠点）**: 専用の赤・青画像を使用する。

| 拠点ID | 拠点名 | プレイヤー1（赤） | プレイヤー2（青） |
|--------|--------|-----------------|-----------------|
| 13 | GP | `redgpicon.gif` | `brgpicon.gif` |
| 14 | GB | `redgb.gif` | `brgb.gif` |

GP・GB はゲーム開始時に必ずいずれかのプレイヤーが所有しているため、中立状態は存在しない。

**占領可能施設（都市・コロニー・補給基地・スペースベース）**: 基本画像の上に所有者インジケータを重ねて描画する。

| 拠点ID | 拠点名 | 基本画像 |
|--------|--------|---------|
| 15 | 都市 | `cityicon.gif` |
| 16 | コロニー | `colony.gif` |
| 17 | 補給基地 | `baseicon.gif` |
| 18 | スペースベース | `sbase.gif` |

所有者インジケータの仕様:

| 項目 | 値 |
|------|-----|
| サイズ | 8 × 8px |
| 描画位置 | タイルの左上（オフセット 0, 0） |
| プレイヤー1の色 | `#FF0000`（赤） |
| プレイヤー2の色 | `#0000FF`（青） |
| 中立の色 | `#808080`（灰） |

### 3.2 処理ロジック

#### 3.2.1 マップデータ構造

マップデータは以下のオブジェクト構造で保持する。

```javascript
// マップデータ
const mapData = {
  width: 30,       // number: マップ横幅（タイル数）
  height: 20,      // number: マップ縦幅（タイル数）
  terrain: [       // number[][]: 地形IDの2次元配列 [行][列]、値は 1〜18
    [1, 1, 4, 1, 1, 16, 1, 1, 1, 1, ...],  // 行0
    [1, 13, 1, 1, 15, 1, 1, 1, 1, 1, ...],  // 行1
    [2, 3, 6, 5, 2, 17, 2, 2, 2, 2, ...],   // 行2
    // ...
  ],
  facilities: {    // Object: 拠点の所有情報。キーは "列,行" 形式の文字列
    "1,1": { type: 13, owner: 1 },   // GP, プレイヤー1所有
    "5,0": { type: 16, owner: 0 },   // コロニー, 中立
    "4,1": { type: 15, owner: 0 },   // 都市, 中立
    "5,2": { type: 17, owner: 2 },   // 補給基地, プレイヤー2所有
    // ...
  }
};

// owner の値:
//   0 = 中立
//   1 = プレイヤー1（赤）
//   2 = プレイヤー2（青）
```

`terrain` 配列の行数は `height`、各行の要素数は `width` と一致する。`facilities` には `terrain` 上で拠点タイル（ID 13〜18）が配置されているセルの所有情報を格納する。

#### 3.2.2 描画処理

Canvas への描画は以下の手順で1フレーム分を描画する。

**手順1**: Canvas 全体を背景色（`#000000`）でクリアする。

**手順2**: ビューポート内の各タイルを左上から右下へ順に描画する。

```
行ループ: row = scrollY から scrollY + 14 まで
  列ループ: col = scrollX から scrollX + 19 まで
    screenX = (col - scrollX) * 32
    screenY = (row - scrollY) * 32
    terrainId = terrain[row][col]

    terrainId が 1〜12（自然地形）の場合:
      対応する地形画像を (screenX, screenY) に描画する

    terrainId が 13〜14（GP・GB）の場合:
      facilities["col,row"].owner の値に応じた赤・青画像を (screenX, screenY) に描画する

    terrainId が 15〜18（占領可能施設）の場合:
      基本画像を (screenX, screenY) に描画する
      facilities["col,row"].owner の値に応じた所有者インジケータを
      (screenX, screenY) に 8×8px で描画する
```

**手順3**: マップの幅がビューポート（20タイル）未満、またはマップの高さがビューポート（15タイル）未満の場合、描画されないセルは背景色（黒）のままとする。

#### 3.2.3 スクロール制御

ビューポートの表示開始位置を `scrollX`（列）、`scrollY`（行）で管理する。

| 項目 | 値 |
|------|-----|
| scrollX の初期値 | 0 |
| scrollY の初期値 | 0 |
| scrollX の最小値 | 0 |
| scrollX の最大値 | `mapData.width - 20`（0未満にならない） |
| scrollY の最小値 | 0 |
| scrollY の最大値 | `mapData.height - 15`（0未満にならない） |
| スクロール単位 | 1タイル |

スクロール位置の更新は外部（カーソル操作機能）から `scrollX` / `scrollY` を変更することで行う。描画処理は毎フレーム現在の `scrollX` / `scrollY` を参照してビューポート内のタイルを描画する。

マップサイズがビューポート以下の場合（例: 幅が20タイル以下）、その軸方向のスクロールは発生しない（最大値が0になる）。

#### 3.2.4 画像の読み込み

描画開始前に、全18種（＋拠点の色バリエーション）の地形タイル画像を読み込む。

読み込み対象（計21ファイル）:
- 自然地形 12ファイル: `space.gif`, `plainicon.gif`, `foresticon.gif`, `aste.gif`, `seaicon.gif`, `deserticon.gif`, `air.gif`, `volicon.gif`, `moon.gif`, `cresmall.gif`, `bhole.gif`, `crelarge.gif`
- GP 2ファイル: `redgpicon.gif`, `brgpicon.gif`
- GB 2ファイル: `redgb.gif`, `brgb.gif`
- 占領可能施設 4ファイル: `cityicon.gif`, `colony.gif`, `baseicon.gif`, `sbase.gif`
- 進入不可地形汎用アイコン 1ファイル: `block.gif`

画像パス: `assets/terrain/<ファイル名>`

全画像の読み込み完了後に初回描画を実行する。読み込み完了前は Canvas を背景色（黒）のまま表示する。

## 4. 考慮事項・制限事項

- マップのタイル数はシナリオごとに異なる。描画処理はマップサイズに依存しない汎用的な実装とする
- この仕様ではユニットの描画を含まない。ユニット表示は 4-1（ユニットデータ管理）で定義する
- 占領によるオーナー変更は 1-2（占領システム）で処理する。本仕様の描画処理は `facilities` の `owner` 値を参照するだけで、値の変更は行わない
- Canvas のリサイズやレスポンシブ対応は本仕様の範囲外とする。Canvas サイズは 640×480px 固定とする
- 地形タイル画像が読み込めなかった場合のフォールバック表示は本仕様の範囲外とする

## 5. テスト項目

### マップデータ構造

- [ ] `mapData.terrain` の行数が `mapData.height` と一致する
- [ ] `mapData.terrain` の各行の要素数が `mapData.width` と一致する
- [ ] `mapData.terrain` の全要素が 1〜18 の整数値である
- [ ] `mapData.facilities` の各エントリのキーが `"列,行"` 形式の文字列である
- [ ] `mapData.facilities` の各エントリの `type` が 13〜18 のいずれかである
- [ ] `mapData.facilities` の各エントリの `owner` が 0, 1, 2 のいずれかである
- [ ] `mapData.facilities` のキーが指す座標の `terrain` 値が、そのエントリの `type` と一致する

### 地形タイル描画

- [ ] Canvas のサイズが 640×480px で描画される
- [ ] Canvas の背景色が `#000000` で描画される
- [ ] 各地形タイルが 32×32px で描画される
- [ ] ビューポート内に横20 × 縦15 = 300タイルが隙間なく描画される
- [ ] 自然地形（ID 1〜12）が地形IDに対応する画像で描画される
- [ ] 進入不可地形（火山ID=8、ブラックホールID=11）も画像として正常に描画される

### 拠点所有表示

- [ ] GP（ID=13）がプレイヤー1所有時に `redgpicon.gif` で描画される
- [ ] GP（ID=13）がプレイヤー2所有時に `brgpicon.gif` で描画される
- [ ] GB（ID=14）がプレイヤー1所有時に `redgb.gif` で描画される
- [ ] GB（ID=14）がプレイヤー2所有時に `brgb.gif` で描画される
- [ ] 都市（ID=15）の基本画像 `cityicon.gif` が描画される
- [ ] 中立施設（owner=0）に灰色（`#808080`）の 8×8px インジケータが左上に描画される
- [ ] プレイヤー1所有施設（owner=1）に赤色（`#FF0000`）の 8×8px インジケータが左上に描画される
- [ ] プレイヤー2所有施設（owner=2）に青色（`#0000FF`）の 8×8px インジケータが左上に描画される

### スクロール制御

- [ ] 初期表示時に scrollX=0, scrollY=0 でマップ左上から描画される
- [ ] scrollX を変更すると、表示がタイル単位で水平方向にスクロールする
- [ ] scrollY を変更すると、表示がタイル単位で垂直方向にスクロールする
- [ ] scrollX が 0 未満にならない
- [ ] scrollY が 0 未満にならない
- [ ] scrollX が `mapData.width - 20` を超えない
- [ ] scrollY が `mapData.height - 15` を超えない
- [ ] マップ幅が20タイル以下の場合、scrollX が常に 0 になる
- [ ] マップ高さが15タイル以下の場合、scrollY が常に 0 になる

### 画像読み込み

- [ ] 全21ファイルの画像読み込みが完了してから描画が開始される
- [ ] 画像読み込み完了前は Canvas が黒背景のまま表示される

### 境界条件

- [ ] マップサイズがビューポートと同じ（20×15）の場合、全タイルが表示されスクロールが発生しない
- [ ] マップサイズがビューポートより小さい場合、描画されない領域が黒背景で表示される
- [ ] マップサイズがビューポートより大きい場合（例: 30×20）、スクロールで全域を表示できる
