# 仕様書: 1-1 マップ表示

## 1. 概要

戦略シミュレーションパートのマップを画面に表示する機能。
マップは2Dグリッドで構成され、各マスに地形タイプが割り当てられる。
18種の地形タイルを用いてマップを描画し、プレイヤーが戦略を立てるための基盤となる。

## 2. 関連資料

- `docs/capsule_senki_spec.md` セクション2: マップシステム
- `assets/terrain/`: 地形スプライト（16×16ピクセル GIF、21ファイル）
- `assets/maps/`: マップ参考画像（map01.png〜map30.png）

## 3. 機能詳細

### 3.1 画面要素

#### 3.1.1 マップ描画領域

- HTML Canvas を使用してマップを描画する
- マップはグリッド状のタイルで構成される
- タイルサイズ: 16×16 ピクセル（元素材サイズ）、表示時は2倍（32×32）に拡大する
- グリッド線: 1px の薄い線で各タイルの境界を表示する

#### 3.1.2 地形タイプ一覧

| ID | 地形名 | スプライト | 説明 |
|----|--------|-----------|------|
| 0 | 宇宙 | space.gif | 標準的な宇宙空間 |
| 1 | 平野 | plainicon.gif | 地球の平地 |
| 2 | 森林 | foresticon.gif | 木々が生い茂る地形 |
| 3 | アステロイド | aste.gif | 小惑星帯 |
| 4 | 水中 | seaicon.gif | 海や湖の水中 |
| 5 | 砂漠 | deserticon.gif | 砂地の地形 |
| 6 | 大気圏 | air.gif | 大気圏突入エリア |
| 7 | 火山 | volicon.gif | 火山地帯（進入不可） |
| 8 | 小惑星 | moon.gif | 単体の小惑星 |
| 9 | クレータ | cresmall.gif | 衝突跡の地形 |
| 10 | ブラックホール | bhole.gif | 特殊地形（進入不可） |
| 11 | 大クレータ | crelarge.gif | 大型のクレーター |
| 12 | GP | brgpicon.gif / redgpicon.gif | 連邦軍本拠地。所有軍で色が変わる |
| 13 | GB | brgb.gif / redgb.gif | ジオン軍本拠地。所有軍で色が変わる |
| 14 | 都市 | cityicon.gif | 都市部（占領可能） |
| 15 | コロニー | colony.gif | スペースコロニー（占領可能） |
| 16 | 補給基地 | baseicon.gif | 補給施設（占領可能） |
| 17 | スペースベース | sbase.gif | 宇宙基地（占領可能） |

- 進入不可地形の汎用アイコン: block.gif（ID 7, 10 のフォールバック用）

#### 3.1.3 拠点の所有表示

GP（ID:12）と GB（ID:13）は所有軍によってスプライトが切り替わる:

| 拠点 | 青軍（1P） | 赤軍（2P/CPU） |
|------|-----------|---------------|
| GP | brgpicon.gif | redgpicon.gif |
| GB | brgb.gif | redgb.gif |

### 3.2 処理ロジック

#### 3.2.1 マップデータ構造

マップデータは以下の形式の JSON で定義する:

```json
{
  "id": 1,
  "name": "マップ名",
  "width": 15,
  "height": 15,
  "terrain": [
    [0, 0, 0, 1, 1, ...],
    [0, 0, 1, 2, 1, ...],
    ...
  ],
  "facilities": [
    { "x": 3, "y": 2, "type": 12, "owner": "blue" },
    { "x": 10, "y": 12, "type": 13, "owner": "red" }
  ]
}
```

- `terrain`: 2次元配列。各要素は地形 ID（0〜17）
- `facilities`: 拠点情報の配列。所有軍情報を含む
  - `type`: 地形 ID（12:GP, 13:GB, 14:都市, 15:コロニー, 16:補給基地, 17:スペースベース）
  - `owner`: `"blue"` | `"red"` | `"neutral"`（中立）

#### 3.2.2 マップ描画処理

1. Canvas のサイズを `マップ幅 × タイル表示サイズ` × `マップ高さ × タイル表示サイズ` に設定する
2. `terrain` 配列をループし、各マスに対応する地形スプライトを描画する
3. 拠点マス（GP/GB）は `facilities` の `owner` に応じたスプライトを描画する
4. グリッド線を描画する

```
描画順序:
  1. 地形タイル（terrain 配列を走査）
  2. 拠点の所有色スプライト（facilities を走査）
  3. グリッド線（オプション）
```

#### 3.2.3 スプライト読み込み

- 全地形スプライト（21ファイル）をゲーム起動時に事前読み込みする
- 読み込み完了後にマップ描画を開始する
- 読み込み中はローディング表示を行う

#### 3.2.4 マップサイズ

マップサイズはシナリオにより異なる（参考画像からの分析）:

| 分類 | サイズ例 | 該当マップ例 |
|------|---------|------------|
| 小 | 15×15 | map01, map05 |
| 中 | 23×15 | map09 |
| 大 | 31×15 | map17 |

- マップサイズに上限は設けないが、データ定義の `width` / `height` に従う

#### 3.2.5 表示領域とスクロール

- マップ全体が画面に収まらない場合、スクロールにより表示領域を移動できる
- スクロール操作: マウスドラッグまたはキーボード矢印キー
- スクロール範囲はマップの端まで

## 4. 考慮事項・制限事項

- この仕様にはユニットの表示は含まない（ユニット描画は別機能で対応する）
- 占領処理のロジックは 1-2 占領システムで対応する。本機能では所有状態に応じた表示のみ行う
- マップデータ（30シナリオ分）の JSON 定義は、参考画像（map01〜map30.png）を元に別途作成する
- タイル表示サイズ（2倍拡大）は将来的に変更可能にするが、初期実装では固定値とする
- GAS の HTML Service で Canvas を使用する。`HtmlService.createHtmlOutputFromFile()` を利用する

## 5. テスト項目

### マップ描画

- [ ] Canvas 要素が画面に表示される
- [ ] 15×15 マップが正しいサイズ（480×480px = 32×15）で描画される
- [ ] 各地形タイルが正しいスプライト画像で描画される
- [ ] 全18種の地形タイプがそれぞれ正しいスプライトで表示される
- [ ] タイルが32×32ピクセル（2倍拡大）で描画される
- [ ] グリッド線が各タイルの境界に表示される

### 拠点表示

- [ ] GP（青軍所有）が brgpicon.gif で表示される
- [ ] GP（赤軍所有）が redgpicon.gif で表示される
- [ ] GB（青軍所有）が brgb.gif で表示される
- [ ] GB（赤軍所有）が redgb.gif で表示される
- [ ] 中立の施設（都市・コロニー・補給基地・スペースベース）が正しく表示される

### マップデータ

- [ ] JSON 形式のマップデータを読み込んでマップが描画される
- [ ] 異なるサイズのマップ（15×15、23×15、31×15）が正しく描画される
- [ ] 不正な地形 ID が含まれる場合にエラーにならない（block.gif でフォールバック）

### スプライト読み込み

- [ ] 全21種の地形スプライトが事前読み込みされる
- [ ] スプライト読み込み中にローディング表示が出る
- [ ] スプライト読み込み完了後にマップが描画される

### スクロール

- [ ] マップが画面に収まらない場合、マウスドラッグでスクロールできる
- [ ] キーボード矢印キーでスクロールできる
- [ ] スクロール範囲がマップの端を超えない
